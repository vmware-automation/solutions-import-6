define(function(require){var $=require("jquery"),_=require("underscore"),GitHubFileCollection=require("model/gitHubFileCollection"),cp=require("model/commonProperties"),errors=require("model/errorMappings"),cu=require("util/appDirCommon"),uiUtils=require("util/uiUtils"),VMwareJSONModel=require("model/vmWareJSON"),ImportFormModel=require("model/importForm"),GHViewDataModal=require("view/ghViewDataModal"),ProgressBarView=require("view/progressBar"),compiledImportFormTmpl=require("hbs!template/importForm"),compiledWrongBrowser=require("hbs!template/unsupportedBrowser"),compiledPopupBlocked=require("hbs!template/popupBlocked"),compiledNextSteps=require("hbs!template/nextSteps"),dataPoster=require("workers/dataPoster"),marked=require("marked"),Crypto=require("Crypto"),twitterjs=require("twitterjs"),Spinner=require("spin"),eventBus=require("util/appCommonEB");marked.setOptions({gfm:!0,pedantic:!1,sanitize:!0});var activityValues={el:"document",segments:12,width:5.5,space:6,length:13,color:"#252525",outside:!1,speed:1.5},importFormModel=new ImportFormModel;if(!cp.get("page-index").hasClass("chrome-gte20")&&!cp.get("page-index").hasClass("ff-gte15")){var browserInfo={info:"The latest version of Chrome or Firefox is required to work with this page.",supportedBrowsers:[{name:"Google Chrome",version:"20.0",link:"http://www.google.com/chrome",img:"../images/chromeLogo.png"},{name:"Firefox",version:"15.0",link:"http://www.mozilla.org/en-US/firefox",img:"../images/ffLogo.png"}]},context={headerText:"Unsupported Browser",bodyText:compiledWrongBrowser(browserInfo)};return uiUtils.noticeModal(context),undefined}function ImportExportApp(){this.queryParams=$.url().param(),this.vmwareJSONFile=undefined,this.targetFileMeta=undefined,this.readMeFile=undefined,this.errorReadMeFile=undefined,this.nextsStepFile=undefined,this.progressBarEL=undefined,this.progressBar=undefined,this.importButtonEL="#viewImportFileButton",this.viewDataModal=undefined,this.gitHubFileCollection=undefined,this.postParams=undefined,_.bindAll(this)}return ImportExportApp.prototype.postConstruct=function(){var content=compiledImportFormTmpl(importFormModel.toJSON());cp.get("importFormWrapper").html(content),this.queryParams=$.url().param(),this.progressBarEL="#progressGroup",this.progressBar=new ProgressBarView({el:this.progressBarEL}),this.eximep=cp.get("APPD_SE");var missingValues=[];_.isUndefined(this.queryParams.uname)&&missingValues.push("uname"),_.isUndefined(this.queryParams.repo)&&missingValues.push("repo"),_.isUndefined(this.queryParams.branch)&&missingValues.push("branch");if(missingValues.length>0){var missingValuesString=missingValues.join(", ");uiUtils.updateFormDisplay({rdcClass:ALERT_ERROR_CLASSES,rdMsgVal:"Missing <b>["+missingValuesString+"]</b> required parameter(s) to continue. "+errors.get("ERRORS").import});return}$("input:radio[name=importOptionsRadio]").on("click",function(e){$(this).attr("id")=="importNew"?cp.get("importAsNewSuffix").removeAttr("disabled"):cp.get("importAsNewSuffix").attr("disabled",!0)}),cp.get("advancedOptionsWrap").on("hide",function(){cp.get("advancedOptionsChevron").removeClass("icon-chevron-down").addClass("icon-chevron-right")}).on("show",function(){cp.get("advancedOptionsChevron").removeClass("icon-chevron-right").addClass("icon-chevron-down")});var spinner;$(document).ajaxStart(function(){spinner=(new Spinner).spin(cp.get("center")[0])}).ajaxStop(function(){spinner.stop()}),this.initData(),this.gaugesTrack("50b3b654613f5d6634000009")},ImportExportApp.prototype.initData=function(){try{this.gitHubFileCollection=new GitHubFileCollection({userName:this.queryParams.uname,repoName:this.queryParams.repo,sha:this.queryParams.branch})}catch(e){return cu.log("initData: exception: "+e),uiUtils.updateFormDisplay({rdcClass:ALERT_ERROR_CLASSES,rdMsgVal:errors.get("ERRORS").import}),!1}cu.log("Fetching GH repo base dir. file meta-data"),this.gitHubFileCollection.fetch({parse:!1,success:this.ghCollectionSuccessHandler,error:function(collection,response){var msg="Failed to get data from GitHub repository. "+response.statusText;response.status===404&&(msg="The repository or branch was not found on github. Please check the url parameters!"),cu.log("%cImportExportApp failed to get tree: "+response,"color:red; background-color:blue"),uiUtils.updateFormDisplay({rdcClass:ALERT_ERROR_CLASSES,rdMsgVal:errors.get("ERRORS").import})}})},ImportExportApp.prototype.importData=function(postData){var missingValuesString="";if(this.postParams.appdhost===undefined||this.postParams.appdhost=="")missingValuesString="Host Url";if(missingValuesString!=""){uiUtils.updateFormDisplay({rdcClass:ALERT_ERROR_CLASSES,rdMsgVal:"Please enter a valid "+missingValuesString+" to continue!"});return}var paramObject={conflictResolution:this.postParams.conflictResolution,importAsNewSuffix:_.isUndefined(this.postParams.importAsNewSuffix)?"NOOP":this.postParams.importAsNewSuffix,shared:this.postParams.shared},url=[this.postParams.appdhost,this.postParams.appdeximep,"?",$.param(paramObject)].join(""),importSuccessHandler=function(data,textStatus,jqXHR){var msgClass=ALERT_SUCCESS_CLASSES,msgVal="",errored=!1;!_.isBoolean(data.success)||data.success==0?(msgClass=ALERT_ERROR_CLASSES,msgVal=errors.get("ERRORS").import,errored=!0,cp.get("error-readme-content").hide(),this.gaugesTrack("50b3c1fbf5a1f548a9000010")):(this.progressBar.update({value:"100%",text:"Complete!"}),this.gaugesTrack("50b3c1ebf5a1f548a900000f")),uiUtils.updateFormDisplay({rdcClass:msgClass,rdMsgVal:msgVal});if(errored)return;var artifactType="",baseURL=this.postParams.appdhost+"/darwin/#",encodedSegment="";data.applicationId>0||data.applicationsCount>0?(artifactType=data.applicationsCount>1?data.applicationsCount+" Applications":"1 Application",encodedSegment=cu.strToBase64("false:applicationOverviewPage:"+data.applicationId)):data.servicesCount>0?(artifactType=data.servicesCount>1?data.servicesCount+" Services":"1 Service",encodedSegment=cu.strToBase64("false:serviceVersionOverviewPage:"+data.serviceId+":overviewMode=view")):data.scriptTasksCount>0?(artifactType=data.scriptTasksCount>1?data.scriptTasksCount+" Script Tasks":"1 Script Task",encodedSegment=cu.strToBase64("false:taskVersionOverviewPage:"+data.scriptTaskId+":overviewMode=view")):(artifactType="",encodedSegment=cu.strToBase64("false:applicationLanding"));var base64URL=baseURL+encodedSegment;this.displayNextSteps(artifactType,base64URL)};cu.log("Sending to... "+url),$.when(dataPoster({url:url,data:postData,contentType:"application/xml",dataType:"json",beforeSend:this.postParams.beforeSend,xhrFields:this.postParams.xhrFields,error:function(xhr,desc,err){cu.log(xhr),cu.log("Desc: "+desc+"\nErr:"+err)}})).done(_.bind(importSuccessHandler,this)).fail(function(jqXHR,textStatus,errorThrown){cu.log("%cImportExportApp post to app dir returned status: "+jqXHR.status,"color:red; background-color:blue");var msg=errors.get("ERRORS").import;if(errorThrown==="Unauthorized"||jqXHR.status===401)msg=errors.get("ERRORS").authenticate;errorThrown=="timeout"&&(msg=errors.get("ERRORS").connect),uiUtils.updateFormDisplay({rdcClass:ALERT_ERROR_CLASSES,rdMsgVal:msg}),cp.get("error-readme-content").hide()})},ImportExportApp.prototype.gaugesTrack=function(trackingId){return;var t,s},ImportExportApp.prototype.getGHFileRawData=function(model,options){cp.get("responseDataControl").addClass("hidden");var requestOpts=_.extend({},{reset:!1,success:function(model,response,jqXHR){cu.log("!! Empty success callback encountered !!")},error:function(model,error,jqXHR){cu.log("Failed: getting data from GH"),uiUtils.updateFormDisplay({rdcClass:ALERT_ERROR_CLASSES,rdMsgVal:"Failed to get data from GitHub. "+JSON.stringify({name:model.get("path"),code:jqXHR.status,error:error})+" "+errors.get("ERRORS").import})}},options);requestOpts.success=_.bind(requestOpts.success,this),model.fetch(requestOpts)},ImportExportApp.prototype.ghCollectionSuccessHandler=function(collection,response){cu.log("%cImportExportApp received tree data: ","color:yellow; background-color:blue");var jsonFileID=cp.get("VMW_JSON"),jsonMetaFile=collection.get(jsonFileID);if(_.isUndefined(jsonMetaFile)){uiUtils.updateFormDisplay({rdcClass:ALERT_ERROR_CLASSES,rdMsgVal:"Unable to locate the required json configuration file: "+jsonFileID+" "+errors.get("ERRORS").import});return}this.getGHFileRawData(jsonMetaFile,{success:function(model,response,jqXHR){try{var vmwareJSONFile=new VMwareJSONModel({rawJSON:model.get("rawData")});this.targetFileMeta=collection.get(vmwareJSONFile.get("exportFileName")),this.readMeFile=collection.get(vmwareJSONFile.get("exportedFileReadme"));if(_.isUndefined(this.targetFileMeta))throw new Error("Export File: "+vmwareJSONFile.get("exportFileName"))+" missing";if(_.isUndefined(this.readMeFile))throw new Error("Export Readme File: "+vmwareJSONFile.get("exportFileReadme"))+" missing";var optional=vmwareJSONFile.get("optional");this.importSectionHeader=vmwareJSONFile.get("importSectionHeader"),this.vmwareJSONFile=vmwareJSONFile;var optional=this.vmwareJSONFile.get("optional");optional&&optional.enableConsoleLogging==1&&(TESTING=!0,cu.log("Logging output to console")),this.displayReadme()}catch(e){return cu.log("getGHFileRawData: exception: "+e),uiUtils.updateFormDisplay({rdcClass:ALERT_ERROR_CLASSES,rdMsgVal:errors.get("ERRORS").import}),!1}eventBus.triggerEvent(eventBus.getEvents().VMW_JSON_LOADED,this.vmwareJSONFile)}})},ImportExportApp.prototype.displayReadme=function(){this.getGHFileRawData(this.readMeFile,{success:function(model,response,jqXHR){cp.get("readme-content").empty().append(_.escape(response)),this.allowInput()}})},ImportExportApp.prototype.displayErrorReadme=function(){_.isUndefined(this.errorReadMeFile)||this.getGHFileRawData(this.errorReadMeFile,{reset:!0,success:function(model,response,jqXHR){cp.get("error-readme-content").empty().append(_.escape(response)),this.allowInput()}})},ImportExportApp.prototype.displayNextSteps=function(artifactType,importedBPURL){function displayNSFrame(contentParams){var content=compiledNextSteps(contentParams),contentArray=cu.getLinkForData(content,"text/html"),$contentWrapper=cp.get("contentWrapper"),width=$contentWrapper.css("width"),height=$contentWrapper.css("height");cu.log("content: "+content),cu.log("contentLink: "+contentArray[0]),$contentWrapper.empty(),uiUtils.displayIframe({id:"contentWrapper",src:contentArray[0],blob:contentArray[1],originalContent:content,cssObj:{width:width,height:height,padding:"10px"}}),cp.get("importButton").addClass("x-item-disabled").find("button").attr("disabled","disabled")}var optional=this.vmwareJSONFile.get("optional"),contentParams={artifactType:artifactType,importLink:importedBPURL},haveNSFile=!0;!optional||!optional.nextStepsMarkdownFile?(cu.log("No nextSteps file was entered in configuration."),haveNSFile=!1):optional.nextStepsMarkdownFile&&(cu.log("nextSteps File: "+optional.nextStepsMarkdownFile),this.nextsStepFile=this.gitHubFileCollection.get(optional.nextStepsMarkdownFile),this.nextsStepFile||(cu.log("!! ERROR !! nextSteps file was entered in configuration but missing from repo"),haveNSFile=!1));if(!haveNSFile){displayNSFrame(contentParams);return}this.getGHFileRawData(this.nextsStepFile,{success:function(model,response,jqXHR){contentParams.nextStepsContent=marked(model.get("rawData")),displayNSFrame(contentParams)}})},ImportExportApp.prototype.allowInput=function(){this.viewDataModal=new GHViewDataModal({model:this.targetFileMeta,clickTarget:this.importButtonEL,showModal:!1}),this.bindImportForm()},ImportExportApp.prototype.bindImportForm=function(){var fName=this.targetFileMeta.get("path"),header=_.isUndefined(this.importSectionHeader)?fName.split(".")[0]:this.importSectionHeader;cp.get("bpExportFN").attr("placeholder",fName),cp.get("importHeader").empty().text("Import "+header),$("#importForm").validate({showErrors:function(errorMap,errorList){$.each(this.validElements(),function(index,element){$(element).data("title","").css({"background-color":"white"}).tooltip("destroy")}),$.each(errorList,function(index,error){$(error.element).tooltip("destroy").data("title",error.message).css({"background-color":"red"}).tooltip()})},submitHandler:_.bind(function(form,e){e.preventDefault();var uname=cp.get("appDirUserName").val()?cp.get("appDirUserName").val():cp.get("appDirUserName").attr("placeholder"),password=cp.get("appDirPassword").val()?cp.get("appDirPassword").val():cp.get("appDirPassword").attr("placeholder"),appdhost=cp.get("appDirHost").val()?cp.get("appDirHost").val():cp.get("appDirHost").attr("placeholder"),bytes=Crypto.charenc.Binary.stringToBytes(uname+":"+password),authToken=Crypto.util.bytesToBase64(bytes),conflictResolution=$(":checked","#advancedOptionsWrap").val(),importAsNewSuffix=conflictResolution=="IMPORTASNEW"?cp.get("importAsNewSuffix").val()?cp.get("importAsNewSuffix").val():cp.get("importAsNewSuffix").attr("placeholder"):null,shared=cp.get("shared").is(":checked");appdhost="http://"+appdhost+":8080",this.postParams={uname:uname,password:password,appdhost:appdhost,appdeximep:this.eximep,conflictResolution:conflictResolution,shared:shared,beforeSend:function(xhr){},xhrFields:{withCredentials:!0}},importAsNewSuffix!==null&&(this.postParams.importAsNewSuffix=importAsNewSuffix),this.progressBar.show().update({value:"0%",text:"Importing..."}),cu.log("ImportExportApp form submitted"),this.getGHFileRawData(this.targetFileMeta,{reset:!0,success:function(model,response,jqXHR){this.progressBar.update({value:"50%"}),cu.log("%cImportExportApp sending import data to app dir, user: "+this.postParams.uname+" app dir host: "+this.postParams.appdhost,"color:yellow; background-color:blue"),this.importData(model.get("rawData"))}})},this)})},new ImportExportApp});